{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Nova Avaliação | TrackReview{% endblock %}

{% block content %}
<style>
  .form-wrapper {
    max-width: 700px;
    margin: auto;
    background: white;
    padding: 2rem 2.5rem;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  }
  .form-wrapper h2 {
    font-family: 'Lora', serif;
    margin-bottom: 2rem;
  }
  .autocomplete-list {
    position: absolute;
    z-index: 10;
    background: white;
    border: 1px solid #ddd;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    border-radius: 0.5rem;
  }
  .autocomplete-item {
    padding: 10px;
    cursor: pointer;
  }
  .autocomplete-item:hover {
    background: #f1f1f1;
  }
  .cover-preview {
    max-height: 250px;
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 1rem;
  }
  .rating label {
    font-size: 1.7rem;
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s ease;
  }
  .rating input[type="radio"] {
    display: none;
  }
  .rating input[type="radio"]:checked ~ label,
  .rating label:hover,
  .rating label:hover ~ label {
    color: #d4af37;
  }
</style>

<div class="container my-5">
  <div class="form-wrapper position-relative">
    <h2>Nova Avaliação</h2>
    <form method="post">
      {% csrf_token %}

      {{ form.title|as_crispy_field }}
      {{ form.artist|as_crispy_field }}

      <div class="form-group position-relative">
        <label for="album_search">Buscar Álbum *</label>
        <input type="text" id="album_search" class="form-control" placeholder="Digite o nome do álbum..." autocomplete="off">
        <div id="album_list" class="autocomplete-list" style="display: none;"></div>
      </div>

      <div id="cover-preview" style="display: none;">
        <img id="preview-image" src="" alt="Preview da capa" class="img-fluid cover-preview">
      </div>

      <!-- Campos ocultos preenchidos via JS -->
      <input type="hidden" name="album" id="id_album">
      <input type="hidden" name="album_cover_url" id="id_album_cover_url">

      <div class="form-group mt-4">
        <label>{{ form.rating.label }}</label>
        <div class="rating d-flex flex-row-reverse justify-content-start">
          {% for value, label in form.rating.field.choices %}
            <input type="radio" id="star{{ value }}" name="rating" value="{{ value }}" {% if form.rating.value == value|stringformat:"s" %}checked{% endif %}>
            <label for="star{{ value }}">&#9733;</label>
          {% endfor %}
        </div>
      </div>

      {{ form.description|as_crispy_field }}

      <div class="mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">Publicar</button>
        <a href="{% url 'post_list' %}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<script>
  const albumInput = document.getElementById("album_search");
  const albumList = document.getElementById("album_list");
  const preview = document.getElementById("cover-preview");
  const img = document.getElementById("preview-image");

  const albumField = document.getElementById("id_album");
  const coverField = document.getElementById("id_album_cover_url");

  let timeout = null;

  function handleAlbums(json) {
    console.log("Recebido da Deezer:", json);
    albumList.innerHTML = "";
    if (!json.data) return;

    json.data.slice(0, 6).forEach(album => {
      const item = document.createElement("div");
      item.className = "autocomplete-item";
      item.textContent = `${album.title} – ${album.artist.name}`;
      item.onclick = () => {
        albumInput.value = album.title;
        albumField.value = album.title;
        coverField.value = album.cover_medium;
        img.src = album.cover_medium;
        preview.style.display = "block";
        albumList.style.display = "none";
      };
      albumList.appendChild(item);
    });

    albumList.style.display = json.data.length ? "block" : "none";
  }

  albumInput.addEventListener("input", () => {
    const query = albumInput.value.trim();
    clearTimeout(timeout);

    if (query.length < 3) {
      albumList.style.display = "none";
      return;
    }

    timeout = setTimeout(() => {
      const callbackName = "deezer_callback_" + Math.floor(Math.random() * 1000000);
      const script = document.createElement("script");
      script.src = `https://api.deezer.com/search/album?q=${encodeURIComponent(query)}&output=jsonp&callback=${callbackName}`;
      window[callbackName] = function(data) {
        handleAlbums(data);
        delete window[callbackName];
        document.body.removeChild(script);
      };
      document.body.appendChild(script);
    }, 400);
  });

  document.addEventListener("click", (e) => {
    if (!albumList.contains(e.target) && e.target !== albumInput) {
      albumList.style.display = "none";
    }
  });
</script>
{% endblock %}
