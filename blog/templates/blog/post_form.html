{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Nova Avaliação | TrackReview{% endblock %}

{% block content %}
<style>
  .form-wrapper {
    max-width: 700px;
    margin: auto;
    background: white;
    padding: 2rem 2.5rem;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  }
  .form-wrapper h2 {
    font-family: 'Lora', serif;
    margin-bottom: 2rem;
  }
  .form-control {
    border-radius: 0.5rem;
    box-shadow: none;
    border: 1px solid #ced4da;
  }
  .rating label {
    font-size: 2rem;
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s ease;
    margin-left: 0.2rem;
    margin-right: 0.2rem;
  }
  .rating input[type="radio"]:checked ~ label,
  .rating label:hover,
  .rating label:hover ~ label {
    color: #d4af37;
  }
  .cover-preview {
    max-height: 250px;
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 1rem;
  }
</style>

<div class="container my-5">
  <div class="form-wrapper">
    <h2>Nova Avaliação</h2>
    <form method="post">
      {% csrf_token %}

      {{ form.title|as_crispy_field }}
      {{ form.artist|as_crispy_field }}
      {{ form.album|as_crispy_field }}
      {{ form.album_cover_url|as_crispy_field }}

      <div id="cover-preview" style="display: none;">
        <img id="preview-image" src="" alt="Preview da capa" class="img-fluid cover-preview">
      </div>

      <div class="form-group mt-4">
        <label>{{ form.rating.label }}</label>
        <div class="rating d-flex flex-row-reverse justify-content-start">
          {% for value, label in form.rating.field.choices %}
            <input type="radio" id="star{{ value }}" name="rating" value="{{ value }}" {% if form.rating.value == value|stringformat:"s" %}checked{% endif %} style="display: none;">
            <label for="star{{ value }}">&#9733;</label>
          {% endfor %}
        </div>
      </div>

      {{ form.description|as_crispy_field }}

      <div class="mt-4 d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">Publicar</button>
        <a href="{% url 'post_list' %}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<script>
  const urlField = document.getElementById("id_album_cover_url");
  const preview = document.getElementById("cover-preview");
  const img = document.getElementById("preview-image");

  function updatePreview() {
    const url = urlField.value;
    if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
      img.src = url;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
      img.src = "";
    }
  }

  urlField.addEventListener("input", updatePreview);
  window.addEventListener("load", updatePreview);
</script>
{% endblock %}
