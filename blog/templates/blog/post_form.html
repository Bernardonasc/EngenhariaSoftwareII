{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Nova Avaliação | TrackReview{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
  <h2 class="mb-4">Nova Avaliação</h2>
  <form method="post">
    {% csrf_token %}

    {{ form.title|as_crispy_field }}
    {{ form.artist|as_crispy_field }}
    {{ form.album|as_crispy_field }}

    <div class="form-group">
      <label for="id_album_cover_url">{{ form.album_cover_url.label }}</label>
      {{ form.album_cover_url }}
      <div id="cover-preview" class="mt-3" style="display: none;">
        <img id="preview-image" src="" alt="Preview da capa" class="img-fluid rounded shadow-sm" style="max-height: 250px;">
      </div>
    </div>

    <div class="form-group">
      <label>{{ form.rating.label }}</label>
      <div class="rating d-flex flex-row-reverse justify-content-end">
        {% for value, label in form.rating.field.choices %}
          <input type="radio" id="star{{ value }}" name="rating" value="{{ value }}" {% if form.rating.value == value|stringformat:"s" %}checked{% endif %} style="display:none;">
          <label for="star{{ value }}" style="font-size: 1.7rem; color: #ccc; cursor: pointer;">&#9733;</label>
        {% endfor %}
      </div>
    </div>

    {{ form.description|as_crispy_field }}

    <div class="mt-4">
      <button type="submit" class="btn btn-primary">Publicar</button>
      <a href="{% url 'post_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
  const urlField = document.getElementById("id_album_cover_url");
  const preview = document.getElementById("cover-preview");
  const img = document.getElementById("preview-image");

  function updatePreview() {
    const url = urlField.value;
    if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
      img.src = url;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
      img.src = "";
    }
  }

  urlField.addEventListener("input", updatePreview);
  window.addEventListener("load", updatePreview);
</script>
{% endblock %}
